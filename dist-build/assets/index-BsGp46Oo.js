import M from"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const m of a.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&o(m)}).observe(document,{childList:!0,subtree:!0});function r(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(t){if(t.ep)return;t.ep=!0;const a=r(t);fetch(t.href,a)}})();const{FaceLandmarker:s,FilesetResolver:N,DrawingUtils:T}=M,y=document.getElementById("demos");document.getElementById("image-blend-shapes");const R=document.getElementById("video-blend-shapes");let h,f="IMAGE",E,p=!1,C=[],w=0,A=Date.now(),g=0,v=!1,b=[];async function B(){const n=await N.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm");h=await s.createFromOptions(n,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task",delegate:"GPU"},outputFaceBlendshapes:!0,runningMode:f,numFaces:1}),y==null||y.classList.remove("invisible")}B();let i=document.getElementById("webcam"),d=document.getElementById("output_canvas"),l=d.getContext("2d");function I(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}async function S(n){i.remove();const e=document.querySelector(".prewebcam");e.innerHTML=`        
        <video id="webcam" autoplay playsinline></video>
        <canvas
          class="output_canvas"
          id="output_canvas"
          style="position: absolute; left: 0px; top: 0px"
        ></canvas>
    `,i=document.getElementById("webcam"),d=document.getElementById("output_canvas"),l=d.getContext("2d"),c=new T(l),setTimeout(()=>{L(null,n)},2e3)}if(I()){const n=document.getElementById("select-webcam");n.onchange=e=>{S(e.target.value)},navigator.mediaDevices.enumerateDevices().then(e=>{C=e.filter(r=>r.kind==="videoinput"),C.forEach(r=>{const o=document.createElement("option");o.value=r.deviceId;const t=r.label||`Camera ${count++}`,a=document.createTextNode(t);o.appendChild(a),n.appendChild(o)}),E=document.getElementById("webcamButton"),E.addEventListener("click",L),setTimeout(L,2e3)})}else console.warn("getUserMedia() is not supported by your browser");function L(n,e){if(!h){console.log("Wait! faceLandmarker not loaded yet.");return}p===!0&&!e?(p=!1,E.innerHTML='<i class="fa-regular fa-circle"></i> Tracking'):(p=!0,E.innerHTML='<i class="fa-regular fa-circle-check"></i> Tracking');const r={video:!0};e&&(r.video={deviceId:e}),navigator.mediaDevices.getUserMedia(r).then(o=>{i.srcObject=o,i.addEventListener("loadeddata",F)})}let _=-1,u,c=new T(l);async function F(){w++,i.videoHeight/i.videoWidth,i.style.width="100%",i.style.height="auto",d.style.width="100%",d.style.height="100%",d.width=i.videoWidth,d.height=i.videoHeight,f==="IMAGE"&&(f="VIDEO",await h.setOptions({runningMode:f}));let n=performance.now();if(_!==i.currentTime&&(_=i.currentTime,u=h.detectForVideo(i,n)),u.faceLandmarks)for(const e of u.faceLandmarks)c.drawConnectors(e,s.FACE_LANDMARKS_TESSELATION,{color:"#C0C0C070",lineWidth:1}),c.drawConnectors(e,s.FACE_LANDMARKS_RIGHT_EYE,{color:"#fff",lineWidth:2}),c.drawConnectors(e,s.FACE_LANDMARKS_RIGHT_EYEBROW,{color:"#e14eca",lineWidth:2}),c.drawConnectors(e,s.FACE_LANDMARKS_LEFT_EYE,{color:"#fff",lineWidth:2}),c.drawConnectors(e,s.FACE_LANDMARKS_LEFT_EYEBROW,{color:"#e14eca",lineWidth:2}),c.drawConnectors(e,s.FACE_LANDMARKS_FACE_OVAL,{color:"#E0E0E0",lineWidth:2}),c.drawConnectors(e,s.FACE_LANDMARKS_LIPS,{color:"#E0E0E0",lineWidth:2}),c.drawConnectors(e,s.FACE_LANDMARKS_RIGHT_IRIS,{color:"#00f2c3",lineWidth:2}),c.drawConnectors(e,s.FACE_LANDMARKS_LEFT_IRIS,{color:"#00f2c3",lineWidth:2});if(D(R,u.faceBlendshapes),p===!0){const e=Date.now();e-A>=1e3&&(g=w,w=0,A=e),l.fillStyle="white",l.font="24px Arial",l.save(),l.scale(-1,1);const o=l.measureText(`FPS: ${g}`).width;l.fillText(`FPS: ${g}`,-10-o,30),l.restore(),window.requestAnimationFrame(F)}}function D(n,e){if(!e.length)return;v&&b.push([...e[0].categories,{index:e[0].categories.length,score:g,categoryName:"fps",displayName:"fps"}]);let r="";e[0].categories.map(o=>{r+=`
        <tr>
            <td>${o.displayName||o.categoryName}</td>
            <td class="text-center">
                <div class="progress-container progress-sm pl-3">
                    <div class="progress">
                        <span class="progress-value">${(+o.score).toFixed(4)}</span>
                        <div class="progress-bar " role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: calc(${+o.score*100}% );"></div>
                    </div>
                </div>
            </td>
        </tr>`}),n.innerHTML=r}function W(n){const e=typeof n!="object"?JSON.parse(n):n;if(e.length%53!==0)return console.error("Data doesn't appear to be a multiple of 53. Can't segment properly."),"";let o=e.slice(0,53).map(t=>t.displayName||t.categoryName).join(",")+`
`;for(let t=0;t<e.length;t+=53){let a=e.slice(t,t+53).map(m=>m.score.toFixed(["fps"].includes(m.displayName)?0:4)).join(",");o+=a+`
`}return o}function k(n){if(n.length){let e=W(n.flat()),r=new Blob([e],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a"),t=URL.createObjectURL(r);o.setAttribute("href",t);const a=window.electron.sendSync("generate-take-filename");o.setAttribute("download",a),document.body.appendChild(o),o.click(),document.body.removeChild(o)}}function x(){v=!v;const n=document.getElementById("recordButton");v?(n.innerHTML='<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span> Stop Recording',n.className="btn btn-success",b=[]):(n.innerHTML='<i class="fa-solid fa-circle"></i> Start Recording',n.className="btn btn-primary",k(b))}document.getElementById("recordButton").addEventListener("click",x);
